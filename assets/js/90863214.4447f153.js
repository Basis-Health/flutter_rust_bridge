"use strict";(self.webpackChunkflutter_rust_bridge=self.webpackChunkflutter_rust_bridge||[]).push([[1291],{3905:(e,t,r)=>{r.d(t,{Zo:()=>p,kt:()=>d});var n=r(7294);function a(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function i(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function l(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?i(Object(r),!0).forEach((function(t){a(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):i(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function s(e,t){if(null==e)return{};var r,n,a=function(e,t){if(null==e)return{};var r,n,a={},i=Object.keys(e);for(n=0;n<i.length;n++)r=i[n],t.indexOf(r)>=0||(a[r]=e[r]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)r=i[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}var o=n.createContext({}),u=function(e){var t=n.useContext(o),r=t;return e&&(r="function"==typeof e?e(t):l(l({},t),e)),r},p=function(e){var t=u(e.components);return n.createElement(o.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},c=n.forwardRef((function(e,t){var r=e.components,a=e.mdxType,i=e.originalType,o=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),c=u(r),d=a,f=c["".concat(o,".").concat(d)]||c[d]||m[d]||i;return r?n.createElement(f,l(l({ref:t},p),{},{components:r})):n.createElement(f,l({ref:t},p))}));function d(e,t){var r=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=r.length,l=new Array(i);l[0]=c;var s={};for(var o in t)hasOwnProperty.call(t,o)&&(s[o]=t[o]);s.originalType=e,s.mdxType="string"==typeof e?e:a,l[1]=s;for(var u=2;u<i;u++)l[u]=r[u];return n.createElement.apply(null,l)}return n.createElement.apply(null,r)}c.displayName="MDXCreateElement"},2752:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>o,contentTitle:()=>l,default:()=>m,frontMatter:()=>i,metadata:()=>s,toc:()=>u});var n=r(7462),a=(r(7294),r(3905));const i={},l="Stream / Iterator",s={unversionedId:"guides/types/translatable/stream",id:"guides/types/translatable/stream",title:"Stream / Iterator",description:"What is Stream? In short: call once, return multiple times; like Iterators.",source:"@site/docs/guides/types/translatable/stream.md",sourceDirName:"guides/types/translatable",slug:"/guides/types/translatable/stream",permalink:"/flutter_rust_bridge/guides/types/translatable/stream",draft:!1,editUrl:"https://github.com/fzyzcjy/flutter_rust_bridge/tree/master/website/docs/guides/types/translatable/stream.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Return Types & Exceptions",permalink:"/flutter_rust_bridge/guides/types/translatable/return"},next:{title:"Zero copy",permalink:"/flutter_rust_bridge/guides/types/translatable/zero-copy"}},o={},u=[{value:"Stream argument in arbitrary types",id:"stream-argument-in-arbitrary-types",level:3},{value:"Examples",id:"examples",level:2},{value:"Streaming from Dart/Flutter to Rust",id:"streaming-from-dartflutter-to-rust",level:3},{value:"Simple timer",id:"simple-timer",level:3},{value:"Stream object inside arbitrary types",id:"stream-object-inside-arbitrary-types",level:3}],p={toc:u};function m(e){let{components:t,...r}=e;return(0,a.kt)("wrapper",(0,n.Z)({},p,r,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"stream--iterator"},"Stream / Iterator"),(0,a.kt)("p",null,"What is ",(0,a.kt)("inlineCode",{parentName:"p"},"Stream"),"? In short: call once, return multiple times; like ",(0,a.kt)("inlineCode",{parentName:"p"},"Iterator"),"s."),(0,a.kt)("p",null,"Flutter's ",(0,a.kt)("a",{parentName:"p",href:"https://dart.dev/tutorials/language/streams"},"Stream")," is a powerful abstraction. When using it as the return value of Rust function, we can allow the scenario that we call function once, and then return multiple times."),(0,a.kt)("p",null,"For example, your Rust function may run computationally heavy algorithms, and for every hundreds of milliseconds, it finds out a new piece of the full solution. In this case, it can immediately give that piece to Flutter, then Flutter can render it to UI immediately. Therefore, users do not need to wait for the full algorithm to finish before he can see some partial results on the user interface."),(0,a.kt)("p",null,"As for the details, a Rust function with signature like ",(0,a.kt)("inlineCode",{parentName:"p"},"fn f(sink: StreamSink<T>, ..) -> Result<()>")," is translated to a Dart function ",(0,a.kt)("inlineCode",{parentName:"p"},"Stream<T> f(..)"),"."),(0,a.kt)("p",null,"Notice that, you can hold that ",(0,a.kt)("inlineCode",{parentName:"p"},"StreamSink")," forever, and use it freely even ",(0,a.kt)("em",{parentName:"p"},"after the Rust function itself returns"),". The logger example below also demonstrates this (the ",(0,a.kt)("inlineCode",{parentName:"p"},"create_log_stream")," returns almost immediately, while you can use the ",(0,a.kt)("inlineCode",{parentName:"p"},"StreamSink")," after, say, an hour)."),(0,a.kt)("p",null,"The ",(0,a.kt)("inlineCode",{parentName:"p"},"StreamSink")," can be placed at any location. For example, ",(0,a.kt)("inlineCode",{parentName:"p"},"fn f(a: i32, b: StreamSink<String>)")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"fn f(a: StreamSink<String>, b: i32)")," are both valid."),(0,a.kt)("h3",{id:"stream-argument-in-arbitrary-types"},"Stream argument in arbitrary types"),(0,a.kt)("p",null,"The ",(0,a.kt)("inlineCode",{parentName:"p"},"StreamSink")," type can also be placed in arbitrary types, such as inside structs, enums, vectors, ...\nSee example 3 below for more details."),(0,a.kt)("h2",{id:"examples"},"Examples"),(0,a.kt)("p",null,"See ",(0,a.kt)("a",{parentName:"p",href:"../../how-to/logging"},"logging examples")," which uses streams extensively."),(0,a.kt)("h3",{id:"streaming-from-dartflutter-to-rust"},"Streaming from Dart/Flutter to Rust"),(0,a.kt)("p",null,"Simply iterate through your Dart stream, and call a normal Rust function for each item.\nFor example:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-dart"},"myStream.listen((data) => myRustfunction(data));\n")),(0,a.kt)("p",null,"While on the Rust side:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-rust"},"fn my_rust_function(data: WhateverType) { ... }\n")),(0,a.kt)("h3",{id:"simple-timer"},"Simple timer"),(0,a.kt)("p",null,"Credits: ",(0,a.kt)("a",{parentName:"p",href:"https://gist.github.com/Desdaemon/be5da0a1c6b4724f20093ef434959744"},"this")," and ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/fzyzcjy/flutter_rust_bridge/issues/347"},"#347"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-rust"},"use anyhow::Result;\nuse std::{thread::sleep, time::Duration};\n\nuse crate::frb_generated::StreamSink;\n\nconst ONE_SECOND: Duration = Duration::from_secs(1);\n\n// can't omit the return type yet, this is a bug\npub fn tick(sink: StreamSink<i32>) -> Result<()> {\n    let mut ticks = 0;\n    loop {\n        sink.add(ticks);\n        sleep(ONE_SECOND);\n        if ticks == i32::MAX {\n            break;\n        }\n        ticks += 1;\n    }\n    Ok(())\n}\n")),(0,a.kt)("p",null,"And use it in Dart:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-dart"},"import 'package:flutter/material.dart';\nimport 'ffi.dart';\n\nvoid main() {\n  runApp(const MyApp());\n}\n\nclass MyApp extends StatelessWidget {\n  const MyApp({Key? key}) : super(key: key);\n\n  @override\n  Widget build(BuildContext context) {\n    return MaterialApp(\n      title: 'Flutter Demo',\n      theme: ThemeData(\n        primarySwatch: Colors.blue,\n      ),\n      home: const MyHomePage(title: 'Flutter Demo Home Page'),\n    );\n  }\n}\n\nclass MyHomePage extends StatefulWidget {\n  const MyHomePage({Key? key, required this.title}) : super(key: key);\n  final String title;\n\n  @override\n  State<MyHomePage> createState() => _MyHomePageState();\n}\n\nclass _MyHomePageState extends State<MyHomePage> {\n  late Stream<int> ticks;\n\n  @override\n  void initState() {\n    super.initState();\n    ticks = api.tick();\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return Scaffold(\n      appBar: AppBar(\n        title: Text(widget.title),\n      ),\n      body: Center(\n        child: Column(\n          mainAxisAlignment: MainAxisAlignment.center,\n          children: <Widget>[\n            const Text(\"Time since starting Rust stream\"),\n            StreamBuilder<int>(\n              stream: ticks,\n              builder: (context, snap) {\n                final style = Theme.of(context).textTheme.headlineMedium;\n                final error = snap.error;\n                if (error != null)\n                  return Tooltip(\n                      message: error.toString(),\n                      child: Text('Error', style: style));\n\n                final data = snap.data;\n                if (data != null) return Text('$data second(s)', style: style);\n\n                return const CircularProgressIndicator();\n              },\n            )\n          ],\n        ),\n      ),\n    );\n  }\n}\n")),(0,a.kt)("h3",{id:"stream-object-inside-arbitrary-types"},"Stream object inside arbitrary types"),(0,a.kt)("p",null,"For example, we can place it as a field of a struct or inside a vector:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-rust"},"pub struct MyStruct {\n    a: String,\n    b: StreamSink<i32>,\n}\n\npub fn f(arr: Vec<StreamSink<i32>>, st: MyStruct) {}\n")))}m.isMDXComponent=!0}}]);